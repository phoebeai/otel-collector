# PDOT Configuration: Full (Datadog + Prometheus Scraper + Remote Write)
# Use this config when you need multiple receivers (excludes federation)

extensions:
  health_check:
    endpoint: 0.0.0.0:${env:OTEL_HEALTHCHECK_PORT:-13133}

receivers:
  datadog:
    endpoint: 0.0.0.0:${env:OTEL_DATADOG_RECEIVER_PORT:-8226}
    read_timeout: 60s
    trace_id_cache_size: 100

  prometheusremotewrite:
    endpoint: 0.0.0.0:${env:OTEL_PROMETHEUS_REMOTE_WRITE_PORT:-9090}

  prometheus:
    config:
      scrape_configs:
        - job_name: 'file_sd'
          scrape_interval: ${env:OTEL_PROMETHEUS_SCRAPE_INTERVAL:-15s}
          scrape_timeout: ${env:OTEL_PROMETHEUS_SCRAPE_TIMEOUT:-10s}
          file_sd_configs:
            - files:
                - ${env:OTEL_PROMETHEUS_TARGETS_FILE:-/etc/pdot/targets.yaml}
              refresh_interval: 30s

processors:
  batch:
    timeout: 30s
    send_batch_size: 10000
    send_batch_max_size: 15000

  resourcedetection/env:
    detectors:
      - env
    override: true
    timeout: 5s

  transform/datadoglogs:
    error_mode: "ignore"
    log_statements:
      - set(log.time_unix_nano, log.attributes["timestamp"]*1000000)

exporters:
  otlphttp/phoebe:
    endpoint: ${env:OTEL_EXPORTER_ENDPOINT:-https://ingest.phoebe.ai/otel}
    compression: gzip
    headers:
      X-API-Key: ${env:PHOEBE_API_KEY}

service:
  telemetry:
    logs:
      level: "INFO"
      encoding: "json"
    metrics:
      readers:
        - pull:
            exporter:
              prometheus:
                host: ${env:OTEL_PROMETHEUS_HOST:-127.0.0.1}
                port: ${env:OTEL_PROMETHEUS_PORT:-8888}
  extensions:
    - health_check
  pipelines:
    traces:
      receivers:
        - datadog
      processors:
        - batch
      exporters:
        - otlphttp/phoebe

    metrics:
      receivers:
        - datadog
      processors:
        - resourcedetection/env
        - batch
      exporters:
        - otlphttp/phoebe

    logs:
      receivers:
        - datadog
      processors:
        - transform/datadoglogs
        - batch
      exporters:
        - otlphttp/phoebe

    metrics/prometheusremotewrite:
      receivers:
        - prometheusremotewrite
      processors:
        - batch
      exporters:
        - otlphttp/phoebe

    metrics/prometheus:
      receivers:
        - prometheus
      processors:
        - batch
      exporters:
        - otlphttp/phoebe
