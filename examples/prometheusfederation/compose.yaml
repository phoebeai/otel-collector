name: pdot-prometheus-federation

services:
  web:
    build:
      context: ../prometheus/sample-app
    ports:
      - "8089:8089"
    environment:
      FLASK_ENV: development
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  prometheus:
    image: prom/prometheus:v3.2.1
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./rules.yml:/etc/prometheus/rules.yml:ro
    ports:
      - "9091:9090"
    depends_on:
      web:
        condition: service_started

  pdot:
    build:
      context: ../..
    command: ["--config", "/otel/configs/prometheus-federation.yaml"]
    volumes:
      - ./federation.yaml:/etc/pdot/federation.yaml:ro
    environment:
      OTEL_PROMETHEUS_SCRAPE_INTERVAL: 15s
      OTEL_PROMETHEUS_SCRAPE_TIMEOUT: 10s
      OTEL_EXPORTER_ENDPOINT: http://hyperdx:4318
      PHOEBE_API_KEY: fake_key_for_testing_only
    depends_on:
      prometheus:
        condition: service_started
      hyperdx:
        condition: service_healthy
    healthcheck:
      test: "wget -q -O- http://127.0.0.1:13133/"
      start_period: 10s
      interval: 2s
      timeout: 10s
      retries: 20

  hyperdx:
    image: hyperdx/hyperdx-local:latest
    volumes:
      - hyperdx_data:/data/db
      - hyperdx_clickhouse_data:/var/lib/clickhouse
    environment:
      - USAGE_STATS_ENABLED=false
      - BETA_CH_OTEL_JSON_SCHEMA_ENABLED=true
    ports:
      - "8080:8080" # HyperDX UI
      - "8123:8123" # ClickHouse HTTP
    healthcheck:
      test: "wget -q -O- http://127.0.0.1:13133/"
      start_period: 10s
      interval: 2s
      timeout: 10s
      retries: 20

volumes:
  hyperdx_data:
  hyperdx_clickhouse_data:
